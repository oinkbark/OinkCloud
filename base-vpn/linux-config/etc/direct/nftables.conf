#!/usr/sbin/nft -f
# tail -f /var/log/syslog

flush ruleset

# In order to support docker
# We must use ip and ip6 instead of just inet

# IPv4
table ip filter {

  chain OUTPUT {
    # Default Allow Outgoing
    type filter hook output priority 0; policy accept;
  }

  chain INPUT {
    # Default Deny Incoming
    type filter hook input priority 0; policy drop;

    # Drop Invalid
    ct state invalid drop
    # Allow Origin Traffic
    ct state established,related accept

    # Allow Localhost
    ip saddr 127.0.0.1 accept;
    iif lo accept;
    meta iifname { docker0, oinkserver0 } accept;

    # Always allow external traffic to reverse proxy
    # Even if not through Docker
    iif eth0 tcp dport 80 accept
    iif eth0 tcp dport 443 accept

    # Allow SSH
    tcp dport 22 accept
    # tcp dport 22 ct state new log prefix "New SSH connection: " accept

    # Allow Vault and Nomad
    tcp dport 4646 accept
    tcp dport 8200 accept

    # Allow VPN
    tcp dport 1194 accept
    udp dport 1194 accept
    meta iifname "tun*" accept

  }

  chain FORWARD {
    # Default Deny Forwarding
    type filter hook forward priority 0; policy drop;

    # VPN
    meta iifname "tun*" counter accept;
    iifname "tun*" oifname "eth0" ct state related,established counter accept;
    iifname "eth0" oifname "tun*" ct state related,established counter accept;
  }

  chain DOCKER {
  }
}

# IPV6
table ip6 filter {
  chain OUTPUT {
    # Default Allow Outgoing
    type filter hook output priority 0; policy accept;
  }

  chain INPUT {
    # Default Deny Incoming
    type filter hook input priority 0; policy drop;

    # Drop Invalid
    ct state invalid drop
    # Allow Origin Traffic
    ct state established,related accept

    # Allow Localhost
    iif lo accept
    meta iifname { docker0, oinkserver0 } accept

    # Always allow external traffic to reverse proxy
    # Even if not through Docker
    iif eth0 tcp dport 80 accept
    iif eth0 tcp dport 443 accept

    # Allow SSH
    tcp dport 22 accept
    # tcp dport 22 ct state new log prefix "New SSH connection: " accept

    # Allow Vault and Nomad
    tcp dport 4646 accept
    tcp dport 8200 accept

    # Allow VPN
    tcp dport 1194 accept
    udp dport 1194 accept
    meta iifname "tun*" accept

    # accept neighbour discovery
    icmpv6 type { nd-neighbor-solicit, echo-request, nd-router-advert, nd-neighbor-advert } accept

  }

  chain FORWARD {
    # Default Deny Forwarding
    type filter hook forward priority 0; policy drop;

    # VPN
    meta iifname "tun*" counter accept;
    iifname "tun*" oifname "eth0" ct state related,established counter accept;
    iifname "eth0" oifname "tun*" ct state related,established counter accept;
  }

  chain DOCKER {
  }
}

table ip nat {
  chain PREROUTING {
    type nat hook prerouting priority -100; policy accept;

    # Consul DNS resolver
    tcp dport 53 counter dnat to 169.254.1.1:8600; log;
    udp dport 53 counter dnat to 169.254.1.1:8600; log;

  }

  chain INPUT {
    type nat hook input priority 100; policy accept;
  }

  chain POSTROUTING {
    type nat hook postrouting priority 100; policy accept;
    oifname "eth0" ip saddr 10.8.0.0/24 counter masquerade; 
  }

  chain OUTPUT {
    type nat hook output priority -100; policy accept;

    # Consul DNS resolver
    ip daddr 169.254.1.1 tcp dport 53 counter dnat to 169.254.1.1:8600; log;
    ip daddr 169.254.1.1 udp dport 53 counter dnat to 169.254.1.1:8600; log;

  }

  chain DOCKER {
  }
}